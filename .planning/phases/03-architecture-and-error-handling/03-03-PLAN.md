---
phase: 03-architecture-and-error-handling
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/pdfparser/pdfparser.go
autonomous: true

must_haves:
  truths:
    - "PDF parser creates single temp directory per parse operation"
    - "Temp directory contains PDF file used by extractor"
    - "ExtractText called only once (not twice) in parse flow"
    - "PDFExtractor interface remains unchanged"
  artifacts:
    - path: "internal/pdfparser/pdfparser.go"
      provides: "Single temp directory creation and cleanup"
      pattern: "MkdirTemp.*pdfparse"
      must_not_contain: "CreateTemp.*\\.pdf"
    - path: "internal/pdfparser/extractor.go"
      provides: "Unchanged PDFExtractor interface"
      pattern: "ExtractText\\(pdfPath string\\) \\(string, error\\)"
  key_links:
    - from: "internal/pdfparser/pdfparser.go ParseWithExtractorAndCategorizer"
      to: "PDFExtractor.ExtractText"
      via: "single call with PDF path"
      pattern: "extractor\\.ExtractText\\(pdfPath\\)"
---

<objective>
Consolidate PDF parser temporary file handling to use a single temp directory and eliminate duplicate ExtractText calls.

Purpose: Reduce file system overhead, simplify cleanup, and fix the inefficiency where ExtractText is called twice (line 70 for validation, line 83 for extraction). The PDFExtractor interface remains unchanged. This addresses DEBT-03 and improves resource management.

Output: PDF parser using single temp directory with one ExtractText call, no interface changes.
</objective>

<execution_context>
@/Users/fjacquet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fjacquet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/phases/01-critical-bugs-and-security/01-01-SUMMARY.md
@internal/pdfparser/pdfparser.go
@internal/pdfparser/extractor.go
</context>

<tasks>

<task type="auto">
  <name>Consolidate temp file handling and eliminate duplicate ExtractText call</name>
  <files>internal/pdfparser/pdfparser.go</files>
  <action>
Modify ParseWithExtractorAndCategorizer (lines 34-91) to:
1. Use temp directory instead of temp file
2. Consolidate duplicate ExtractText calls into one
3. Keep PDFExtractor interface unchanged

**Step 1: Replace temp file with temp directory (lines 39-53)**

CURRENT:
```go
tempFile, err := os.CreateTemp("", "*.pdf")
if err != nil {
    return nil, fmt.Errorf("failed to create temporary PDF file: %w", err)
}
defer func() {
    if err := tempFile.Close(); err != nil {
        logger.WithError(err).Warn("Failed to close temporary file", ...)
    }
    if err := os.Remove(tempFile.Name()); err != nil {
        logger.WithError(err).Warn("Failed to remove temporary file", ...)
    }
}()
```

CHANGE TO:
```go
// Create single temp directory for all PDF processing files
tempDir, err := os.MkdirTemp("", "pdfparse-*")
if err != nil {
    return nil, fmt.Errorf("failed to create temporary directory: %w", err)
}
defer func() {
    if err := os.RemoveAll(tempDir); err != nil {
        logger.WithError(err).Warn("Failed to remove temporary directory",
            logging.Field{Key: "dir", Value: tempDir})
    }
}()

// Create PDF file within temp directory
pdfPath := filepath.Join(tempDir, "input.pdf")
pdfFile, err := os.OpenFile(pdfPath, os.O_CREATE|os.O_WRONLY, 0600)
if err != nil {
    return nil, fmt.Errorf("failed to create temporary PDF file: %w", err)
}
```

**Step 2: Update io.Copy and close (lines 54-64)**

Update references from `tempFile` to `pdfFile` and `tempFile.Name()` to `pdfPath`. Ensure pdfFile is closed before calling extractor.

**Step 3: Consolidate duplicate ExtractText calls (lines 70 and 83)**

CURRENT (two calls):
```go
// Line 70 - Validate
_, err = extractor.ExtractText(tempFile.Name())
if err != nil {
    return nil, fmt.Errorf("failed to validate PDF format: %w", err)
}

// ... some code ...

// Line 83 - Extract
text, err := extractor.ExtractText(tempFile.Name())
if err != nil {
    return nil, fmt.Errorf("failed to extract text from PDF: %w", err)
}
```

CHANGE TO (single call):
```go
// Extract text from PDF (validates format and extracts in one call)
text, err := extractor.ExtractText(pdfPath)
if err != nil {
    return nil, fmt.Errorf("failed to extract text from PDF: %w", err)
}
```

Remove the separate validation call. The extraction itself validates the PDF format - if extraction fails, the error message already indicates the issue.

**Important:**
- DO NOT modify internal/pdfparser/pdfparser_helpers.go
- DO NOT modify internal/pdfparser/extractor.go
- DO NOT change the PDFExtractor interface
- The interface remains: `ExtractText(pdfPath string) (string, error)`
- extractTextFromPDFImpl handles its own internal temp file independently - leave it unchanged

This is a purely internal refactoring of ParseWithExtractorAndCategorizer.
  </action>
  <verify>
    grep "MkdirTemp" internal/pdfparser/pdfparser.go
    grep "RemoveAll" internal/pdfparser/pdfparser.go
    ! grep "CreateTemp.*\\.pdf" internal/pdfparser/pdfparser.go
    grep -c "extractor.ExtractText" internal/pdfparser/pdfparser.go | grep "^1$"
  </verify>
  <done>ParseWithExtractorAndCategorizer creates single temp directory, calls ExtractText once, PDFExtractor interface unchanged</done>
</task>

</tasks>

<verification>
1. Run: `grep "MkdirTemp.*pdfparse" internal/pdfparser/pdfparser.go` - should find temp directory creation
2. Run: `grep "RemoveAll" internal/pdfparser/pdfparser.go` - should find cleanup
3. Run: `grep -c "extractor.ExtractText" internal/pdfparser/pdfparser.go` - should return "1" (single call)
4. Run: `grep "type PDFExtractor interface" internal/pdfparser/extractor.go -A 2` - should show unchanged signature
5. Run tests: `go test -v ./internal/pdfparser/` - all tests pass
</verification>

<success_criteria>
- PDF parser creates single temp directory per parse operation using MkdirTemp
- Temp directory cleaned up with single RemoveAll call
- ExtractText called only once (not twice)
- PDFExtractor interface unchanged at `ExtractText(pdfPath string) (string, error)`
- extractTextFromPDFImpl in pdfparser_helpers.go unchanged
- RealPDFExtractor and MockPDFExtractor unchanged
- All PDF parser tests pass
- Ready for phase 3 verification against DEBT-03 requirement
</success_criteria>

<output>
After completion, create `.planning/phases/03-architecture-and-error-handling/03-03-SUMMARY.md`
</output>
