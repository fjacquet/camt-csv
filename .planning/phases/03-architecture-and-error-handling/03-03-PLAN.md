---
phase: 03-architecture-and-error-handling
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/pdfparser/pdfparser.go
  - internal/pdfparser/pdfparser_helpers.go
autonomous: true

must_haves:
  truths:
    - "PDF parser creates exactly one temp file per parse operation"
    - "Single temp directory contains both PDF and text files"
    - "No duplicate temp file creation in extraction flow"
  artifacts:
    - path: "internal/pdfparser/pdfparser.go"
      provides: "Single temp directory creation"
      pattern: "CreateTemp.*\"\", \"pdfparse-\\*\""
      must_not_contain: "CreateTemp.*\\.pdf"
    - path: "internal/pdfparser/pdfparser_helpers.go"
      provides: "Text extraction using provided path"
      pattern: "func extractTextFromPDFImpl.*outputPath.*string"
      must_not_contain: "CreateTemp.*pdftext"
  key_links:
    - from: "internal/pdfparser/pdfparser.go ParseWithExtractorAndCategorizer"
      to: "internal/pdfparser/pdfparser_helpers.go extractTextFromPDFImpl"
      via: "temp directory path parameter"
      pattern: "extractTextFromPDFImpl.*tempDir"
---

<objective>
Consolidate PDF parser temporary file handling to use a single temp directory instead of creating multiple independent temp files.

Purpose: Reduce file system overhead, simplify cleanup, and eliminate the current double temp file creation pattern (one for PDF, one for extracted text). This addresses DEBT-03 and improves resource management.

Output: PDF parser using single temp directory for all temporary files during PDF processing.
</objective>

<execution_context>
@/Users/fjacquet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fjacquet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/phases/01-critical-bugs-and-security/01-01-SUMMARY.md
@internal/pdfparser/pdfparser.go
@internal/pdfparser/pdfparser_helpers.go
</context>

<tasks>

<task type="auto">
  <name>Refactor extractTextFromPDFImpl to accept temp directory parameter</name>
  <files>internal/pdfparser/pdfparser_helpers.go</files>
  <action>
Modify extractTextFromPDFImpl to accept a temp directory path parameter instead of creating its own temp file:

CURRENT (lines 84-90):
```go
func extractTextFromPDFImpl(pdfFile string) (string, error) {
    // SECURITY: Create a temporary file with random unpredictable name
    tempFile, err := os.CreateTemp("", "pdftext-*.txt")
    if err != nil {
        return "", fmt.Errorf("error creating temporary file: %w", err)
    }
    // ... rest of function
```

CHANGE TO:
```go
func extractTextFromPDFImpl(pdfFile string, tempDir string) (string, error) {
    // Use the provided temp directory for text output
    // This consolidates all temp files into a single directory for easier cleanup
    textFilePath := filepath.Join(tempDir, "extracted.txt")
    textFile, err := os.OpenFile(textFilePath, os.O_CREATE|os.O_WRONLY|os.O_TRUNC, 0600)
    if err != nil {
        return "", fmt.Errorf("error creating text output file: %w", err)
    }
    // ... rest of function using textFile instead of tempFile
```

Update all cleanup logic to use textFile variable instead of tempFile.

Update the RealPDFExtractor.ExtractText method (which calls extractTextFromPDFImpl) to accept tempDir parameter:
- Add tempDir parameter to ExtractText method signature
- Pass tempDir to extractTextFromPDFImpl call

NOTE: This is a breaking change to the PDFExtractor interface. Update the interface definition if needed to include tempDir parameter, or use a different approach that doesn't break the interface (e.g., add ExtractTextWithTempDir method).
  </action>
  <verify>grep -A 5 "func extractTextFromPDFImpl" internal/pdfparser/pdfparser_helpers.go | grep "tempDir string"</verify>
  <done>extractTextFromPDFImpl accepts tempDir parameter and creates text file within provided directory</done>
</task>

<task type="auto">
  <name>Update ParseWithExtractorAndCategorizer to use single temp directory</name>
  <files>internal/pdfparser/pdfparser.go</files>
  <action>
Modify ParseWithExtractorAndCategorizer to create a single temp directory for all PDF processing:

CURRENT (lines 39-53):
```go
// Read the content of the reader into a temporary file for PDF processing
tempFile, err := os.CreateTemp("", "*.pdf")
if err != nil {
    return nil, fmt.Errorf("failed to create temporary PDF file: %w", err)
}
defer func() {
    if err := tempFile.Close(); err != nil {
        logger.WithError(err).Warn("Failed to close temporary file", ...)
    }
    if err := os.Remove(tempFile.Name()); err != nil {
        logger.WithError(err).Warn("Failed to remove temporary file", ...)
    }
}()
```

CHANGE TO:
```go
// Create a single temporary directory for all PDF processing files
tempDir, err := os.MkdirTemp("", "pdfparse-*")
if err != nil {
    return nil, fmt.Errorf("failed to create temporary directory: %w", err)
}
defer func() {
    if err := os.RemoveAll(tempDir); err != nil {
        logger.WithError(err).Warn("Failed to remove temporary directory",
            logging.Field{Key: "dir", Value: tempDir})
    }
}()

// Create PDF file within temp directory
pdfPath := filepath.Join(tempDir, "input.pdf")
pdfFile, err := os.OpenFile(pdfPath, os.O_CREATE|os.O_WRONLY, 0600)
if err != nil {
    return nil, fmt.Errorf("failed to create temporary PDF file: %w", err)
}

// Write reader content to PDF file
_, err = io.Copy(pdfFile, r)
if err != nil {
    pdfFile.Close()
    return nil, fmt.Errorf("failed to write to temporary PDF file: %w", err)
}

// Close PDF file before external command accesses it
if err := pdfFile.Close(); err != nil {
    return nil, fmt.Errorf("failed to close temporary PDF file: %w", err)
}
```

Update the extractor.ExtractText call (line 70, 83) to pass tempDir:
- If using ExtractTextWithTempDir method: `text, err := extractor.ExtractTextWithTempDir(pdfPath, tempDir)`
- If modified ExtractText signature: `text, err := extractor.ExtractText(pdfPath, tempDir)`

Ensure all references to tempFile.Name() are updated to pdfPath.

Result: Single temp directory containing input.pdf and extracted.txt, cleaned up with one RemoveAll call.
  </action>
  <verify>
    grep "MkdirTemp" internal/pdfparser/pdfparser.go
    grep "RemoveAll" internal/pdfparser/pdfparser.go
    ! grep "CreateTemp.*\\.pdf" internal/pdfparser/pdfparser.go
  </verify>
  <done>ParseWithExtractorAndCategorizer creates single temp directory containing both PDF and text files</done>
</task>

</tasks>

<verification>
1. Run: `grep -c "CreateTemp" internal/pdfparser/pdfparser.go internal/pdfparser/pdfparser_helpers.go` - should be 0 (using MkdirTemp and OpenFile instead)
2. Run: `grep "MkdirTemp.*pdfparse" internal/pdfparser/pdfparser.go` - should find temp directory creation
3. Run: `grep "RemoveAll" internal/pdfparser/pdfparser.go` - should find cleanup
4. Run tests: `go test -v ./internal/pdfparser/` - all tests pass
</verification>

<success_criteria>
- PDF parser creates single temp directory per parse operation
- Temp directory contains both input PDF and extracted text files
- Single RemoveAll cleanup instead of multiple Remove calls
- All PDF parser tests pass
- No CreateTemp calls remaining in pdfparser.go or pdfparser_helpers.go
- Ready for phase 3 verification against DEBT-03 requirement
</success_criteria>

<output>
After completion, create `.planning/phases/03-architecture-and-error-handling/03-03-SUMMARY.md`
</output>
