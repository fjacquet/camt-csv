---
phase: 02-configuration-and-state-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/config/config.go
  - cmd/root/root.go
autonomous: true

must_haves:
  truths:
    - "Code builds without referencing removed deprecated functions"
    - "Tests pass without global config variables"
    - "Container nil case logs warning instead of creating unmanaged objects"
  artifacts:
    - path: "internal/config/config.go"
      provides: "Clean config with no deprecated functions or globals"
      min_lines: 0
      must_not_contain: ["func LoadEnv()", "func GetEnv(", "func MustGetEnv(", "var Logger", "globalConfig"]
    - path: "cmd/root/root.go"
      provides: "PersistentPostRun without fallback categorizer creation"
      contains: "if AppContainer != nil"
      must_not_contain: ["else {", "// Fallback to old method"]
  key_links:
    - from: "any Go file"
      to: "deprecated config functions"
      via: "should have zero references"
      pattern: "config\\.(LoadEnv|GetEnv|MustGetEnv|GetGeminiAPIKey|ConfigureLogging)\\("
    - from: "cmd/root/root.go PersistentPostRun"
      to: "AppContainer.GetCategorizer()"
      via: "direct usage without fallback"
      pattern: "AppContainer\\.GetCategorizer\\(\\)"
---

<objective>
Remove all deprecated configuration functions and global mutable state from the config package, and eliminate fallback categorizer creation that bypasses dependency injection.

Purpose: Complete the migration from legacy environment-based configuration to the Viper/Container pattern. This eliminates global mutable state anti-patterns, enforces dependency injection, and ensures container initialization failures propagate properly instead of being silently swallowed.

Output: Clean configuration system with all state flowing through the DI container, no deprecated code remaining, and proper error propagation.
</objective>

<execution_context>
@/Users/fjacquet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fjacquet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Codebase context
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md

# Prior phase patterns
@.planning/phases/01-critical-bugs-and-security/01-01-SUMMARY.md
@.planning/phases/01-critical-bugs-and-security/01-02-SUMMARY.md
@.planning/phases/01-critical-bugs-and-security/01-03-SUMMARY.md

# Files to modify
@internal/config/config.go
@cmd/root/root.go
</context>

<tasks>

<task type="auto">
  <name>Remove deprecated config functions</name>
  <files>internal/config/config.go</files>
  <action>
Delete all deprecated functions from internal/config/config.go:
- ConfigureLogging() (lines 39-79)
- LoadEnv() (lines 81-118)
- GetEnv() (lines 120-140)
- MustGetEnv() (lines 142-163)
- GetGeminiAPIKey() (lines 165-180)
- InitializeGlobalConfig() (lines 182-204)

Keep only:
- Package declaration and deprecation notice comment (lines 1-13)
- Import statements (adjust if any become unused after deletion)
- The rest of the file (viper.go content)

After deletion, verify no references exist in the codebase using grep.
  </action>
  <verify>
```bash
# Verify functions are removed
! grep -n "func LoadEnv\|func GetEnv\|func MustGetEnv\|func GetGeminiAPIKey\|func ConfigureLogging" internal/config/config.go

# Verify no usage in codebase (excluding docs/planning)
! grep -r "config\.\(LoadEnv\|GetEnv\|MustGetEnv\|GetGeminiAPIKey\|ConfigureLogging\)(" --include="*.go" --exclude-dir=".planning" --exclude-dir=".claude" .

# Tests still pass
go test ./internal/config/... -v
```
  </verify>
  <done>Deprecated config functions removed, no references in codebase, config tests pass</done>
</task>

<task type="auto">
  <name>Remove global mutable state</name>
  <files>internal/config/config.go</files>
  <action>
Remove global mutable state from internal/config/config.go:
- Delete `var once sync.Once` (line 26)
- Delete `Logger = logrus.New()` global variable (lines 28-32)
- Delete `globalConfig *Config` global variable (lines 34-36)

Update package comment to remove references to removed globals:
- Remove "Logger (global) -> Use container.GetLogger()" from deprecation notice

Adjust imports if sync, logrus, or other packages are no longer needed. Keep godotenv import only if still used elsewhere in the file.

After deletion, verify no references exist using grep.
  </action>
  <verify>
```bash
# Verify globals are removed
! grep -n "^[[:space:]]*Logger = logrus.New()" internal/config/config.go
! grep -n "^[[:space:]]*globalConfig" internal/config/config.go
! grep -n "^[[:space:]]*once sync.Once" internal/config/config.go

# Verify no usage of these globals
! grep -r "config\.Logger\b" --include="*.go" --exclude-dir=".planning" --exclude-dir=".claude" .

# File still compiles and tests pass
go test ./internal/config/... -v
```
  </done>Global mutable state removed, no references in codebase, tests pass</done>
</task>

<task type="auto">
  <name>Remove fallback categorizer creation</name>
  <files>cmd/root/root.go</files>
  <action>
Remove the fallback categorizer creation from PersistentPostRun in cmd/root/root.go:

Current code (lines 64-93):
```go
PersistentPostRun: func(cmd *cobra.Command, args []string) {
    if AppContainer != nil {
        // Use container's categorizer
        categorizerInstance := AppContainer.GetCategorizer()
        err := categorizerInstance.SaveCreditorsToYAML()
        ...
    } else {
        // Fallback to old method for backward compatibility
        // Deprecated: This will be removed in v2.0.0
        categorizerInstance := categorizer.NewCategorizer(...)
        ...
    }
}
```

Replace with simplified version (no else block):
```go
PersistentPostRun: func(cmd *cobra.Command, args []string) {
    // Save category mappings after command completes
    if AppContainer == nil {
        Log.Warn("Container not initialized, skipping category mapping save")
        return
    }

    categorizerInstance := AppContainer.GetCategorizer()
    err := categorizerInstance.SaveCreditorsToYAML()
    if err != nil {
        Log.WithError(err).Warn("Failed to save creditor mappings")
    }

    err = categorizerInstance.SaveDebitorsToYAML()
    if err != nil {
        Log.WithError(err).Warn("Failed to save debitor mappings")
    }
}
```

This change ensures container initialization failures are visible (logged warning) instead of silently creating unmanaged objects with hardcoded paths.

Remove any now-unused imports (like internal/categorizer or internal/store if they were only used for the fallback).
  </action>
  <verify>
```bash
# Verify else block is removed
! grep -A 15 "PersistentPostRun:" cmd/root/root.go | grep "else {"

# Verify fallback comment is removed
! grep "Fallback to old method" cmd/root/root.go
! grep "Deprecated: This will be removed in v2.0.0" cmd/root/root.go

# Verify new warning is present
grep "Container not initialized, skipping category mapping save" cmd/root/root.go

# Tests pass (root command tests)
go test ./cmd/root/... -v
```
  </verify>
  <done>Fallback categorizer creation removed, nil container logs warning instead of creating objects, tests pass</done>
</task>

</tasks>

<verification>
After all tasks complete, run comprehensive verification:

```bash
# 1. No deprecated functions exist
! grep -n "func LoadEnv\|func GetEnv\|func MustGetEnv" internal/config/config.go

# 2. No global mutable state
! grep -n "^[[:space:]]*Logger = logrus\|globalConfig" internal/config/config.go

# 3. No fallback categorizer creation
! grep -A 20 "PersistentPostRun:" cmd/root/root.go | grep "else {"

# 4. All tests pass
go test ./... -v

# 5. Code builds successfully
go build -o /tmp/camt-csv-test .
```
</verification>

<success_criteria>
- [ ] internal/config/config.go has no deprecated functions (LoadEnv, GetEnv, MustGetEnv, GetGeminiAPIKey, ConfigureLogging)
- [ ] internal/config/config.go has no global variables (Logger, globalConfig, once)
- [ ] cmd/root/root.go PersistentPostRun has no else block creating fallback categorizer
- [ ] Grep confirms zero references to removed functions/globals in *.go files
- [ ] All tests pass: `go test ./...`
- [ ] Code builds successfully
- [ ] Container nil case logs warning instead of creating objects
</success_criteria>

<output>
After completion, create `.planning/phases/02-configuration-and-state-cleanup/02-01-SUMMARY.md` using the summary template. Include:
- Files modified (config.go, root.go)
- Functions/globals removed (6 functions, 3 globals)
- Lines of code removed (approximate)
- Test verification results
- Patterns reinforced (DI container, no global state, error propagation)
</output>
