---
phase: 01-critical-bugs-and-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/logging/mock.go
  - internal/categorizer/categorizer_strategy_test.go
autonomous: true

must_haves:
  truths:
    - "MockLogger properly isolates state so WithError and WithFields create independent instances"
    - "Tests can verify specific log messages were emitted at correct levels"
  artifacts:
    - path: "internal/logging/mock.go"
      provides: "Proper state isolation in MockLogger"
      contains: "make([]LogEntry, len(m.Entries))"
  key_links:
    - from: "WithError method"
      to: "new MockLogger instance"
      via: "copied Entries slice (not shared)"
      pattern: "Entries.*make.*LogEntry.*len"
    - from: "WithFields method"
      to: "new MockLogger instance"
      via: "copied Entries slice (not shared)"
      pattern: "Entries.*make.*LogEntry.*len"
---

<objective>
Fix MockLogger state management so WithError and WithFields methods properly isolate state between instances, enabling reliable test verification of log output.

Purpose: Enable categorizer tests to verify that specific log messages were emitted at correct levels, improving test coverage and reliability.

Output: MockLogger with proper state isolation and categorizer tests that verify logging behavior.
</objective>

<execution_context>
@/Users/fjacquet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fjacquet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fjacquet/Projects/camt-csv/.planning/PROJECT.md
@/Users/fjacquet/Projects/camt-csv/.planning/ROADMAP.md
@/Users/fjacquet/Projects/camt-csv/.planning/STATE.md
@/Users/fjacquet/Projects/camt-csv/CLAUDE.md
@/Users/fjacquet/Projects/camt-csv/.planning/codebase/CONCERNS.md
@/Users/fjacquet/Projects/camt-csv/internal/logging/mock.go
@/Users/fjacquet/Projects/camt-csv/internal/categorizer/categorizer_strategy_test.go
</context>

<tasks>

<task type="auto">
  <name>Fix state isolation in WithError and WithFields</name>
  <files>internal/logging/mock.go</files>
  <action>
Update WithError (lines 86-94) and WithFields (lines 102-111) to create truly independent MockLogger instances by copying the Entries slice instead of sharing it.

Current problematic code in WithError:
```go
func (m *MockLogger) WithError(err error) Logger {
    m.mu.RLock()
    defer m.mu.RUnlock()
    return &MockLogger{
        Entries:       m.Entries,  // ‚Üê SHARED SLICE
        pendingError:  err,
        pendingFields: m.pendingFields,
    }
}
```

Replace with:
```go
func (m *MockLogger) WithError(err error) Logger {
    m.mu.RLock()
    defer m.mu.RUnlock()
    // Create a copy of the Entries slice to isolate state
    entriesCopy := make([]LogEntry, len(m.Entries))
    copy(entriesCopy, m.Entries)
    return &MockLogger{
        Entries:       entriesCopy,
        pendingError:  err,
        pendingFields: m.pendingFields,
    }
}
```

Apply the same pattern to WithFields (lines 102-111):
```go
func (m *MockLogger) WithFields(fields ...Field) Logger {
    m.mu.RLock()
    defer m.mu.RUnlock()
    // Create a copy of the Entries slice to isolate state
    entriesCopy := make([]LogEntry, len(m.Entries))
    copy(entriesCopy, m.Entries)
    allFields := append(m.pendingFields, fields...)
    return &MockLogger{
        Entries:       entriesCopy,
        pendingError:  m.pendingError,
        pendingFields: allFields,
    }
}
```

Rationale: Sharing the Entries slice between instances causes test pollution where log entries from one instance appear in another. Tests cannot reliably verify which logger instance emitted specific messages. Copying the slice ensures each instance has independent state.
  </action>
  <verify>
Run: `grep -A 8 "func.*WithError" internal/logging/mock.go`
Expected: Contains "make([]LogEntry" for slice copying

Run: `grep -A 10 "func.*WithFields" internal/logging/mock.go`
Expected: Contains "make([]LogEntry" for slice copying

Run: `make test`
Expected: All tests pass with proper state isolation
  </verify>
  <done>
- WithError creates new MockLogger with copied Entries slice
- WithFields creates new MockLogger with copied Entries slice
- No shared state between MockLogger instances created via method chaining
- All logging tests pass
  </done>
</task>

<task type="auto">
  <name>Enable logging verification in categorizer tests</name>
  <files>internal/categorizer/categorizer_strategy_test.go</files>
  <action>
Find the TODO comments at lines 176, 232, and 280 that skip logging verification, and replace them with actual logging assertions now that MockLogger properly isolates state.

Example transformation:

Current code (line 176 area):
```go
// TODO: Verify logger was called - mockLogger needs better state tracking
```

Replace with:
```go
// Verify logger emitted debug message about direct mapping
hasDebugLog := false
for _, entry := range mockLogger.Entries {
    if entry.Level == "DEBUG" && strings.Contains(entry.Message, "direct mapping") {
        hasDebugLog = true
        break
    }
}
assert.True(t, hasDebugLog, "Expected debug log about direct mapping")
```

Apply similar verification logic at lines 232 and 280, checking for:
- Line 232: Debug log about keyword matching
- Line 280: Debug log about semantic/AI categorization attempt

The exact log messages to verify should match what the strategies actually emit. Check the strategy implementations to confirm the expected log messages.

Rationale: These TODOs were added because MockLogger state management was broken. Now that it's fixed, tests should verify logging behavior to ensure strategies are logging correctly.
  </action>
  <verify>
Run: `grep -c "TODO.*mockLogger" internal/categorizer/categorizer_strategy_test.go`
Expected: 0 (all TODOs replaced with actual assertions)

Run: `make test`
Expected: All categorizer tests pass with logging verification

Run: `go test -v ./internal/categorizer -run TestDirectMappingStrategy`
Expected: Test passes and verifies debug logging occurred
  </verify>
  <done>
- TODO comments about logging verification removed
- Tests verify that direct mapping strategy emits debug logs
- Tests verify that keyword strategy emits debug logs
- Tests verify that semantic strategy emits debug logs
- All categorizer tests pass with logging assertions
  </done>
</task>

</tasks>

<verification>
Run test suite: `make test`

Specifically verify categorizer tests:
```bash
go test -v ./internal/categorizer -run "TestDirectMappingStrategy|TestKeywordStrategy|TestSemanticStrategy"
```

Check that logging verification is active:
```bash
grep -n "assert.*hasDebugLog\|assert.*Entries" internal/categorizer/categorizer_strategy_test.go
```
Should find logging assertions at the locations where TODOs were removed.
</verification>

<success_criteria>
1. WithError and WithFields create independent MockLogger instances with copied Entries slices
2. No shared state between MockLogger instances
3. Categorizer tests successfully verify logging behavior
4. All TODO comments about logging verification removed and replaced with assertions
5. Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bugs-and-security/01-02-SUMMARY.md`
</output>
