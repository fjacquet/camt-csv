---
phase: 01-critical-bugs-and-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/pdfparser/pdfparser.go
autonomous: true

must_haves:
  truths:
    - "No debug files accumulate in working directory after PDF parsing"
    - "Context cancellation properly propagates through PDF parsing operations"
    - "Temporary files are cleaned up in correct order (close then remove)"
  artifacts:
    - path: "internal/pdfparser/pdfparser.go"
      provides: "PDF parsing without debug file leakage"
      contains: "os.CreateTemp"
      not_contains: "debug_pdf_extract.txt"
  key_links:
    - from: "ParseWithExtractor"
      to: "ParseWithExtractorAndCategorizer"
      via: "context parameter (not Background)"
      pattern: "func ParseWithExtractor.*context\\.Context"
    - from: "defer cleanup"
      to: "tempFile"
      via: "single defer block with close-then-remove"
      pattern: "defer func.*Close.*Remove"
---

<objective>
Fix critical PDF parser bugs that cause debug file accumulation, context loss, and improper temp file cleanup.

Purpose: Eliminate user-visible debug files in working directory, enable proper cancellation support, and ensure clean temporary file handling.

Output: PDF parser that respects context cancellation, produces no debug artifacts, and properly manages temporary files.
</objective>

<execution_context>
@/Users/fjacquet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fjacquet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fjacquet/Projects/camt-csv/.planning/PROJECT.md
@/Users/fjacquet/Projects/camt-csv/.planning/ROADMAP.md
@/Users/fjacquet/Projects/camt-csv/.planning/STATE.md
@/Users/fjacquet/Projects/camt-csv/CLAUDE.md
@/Users/fjacquet/Projects/camt-csv/.planning/codebase/CONCERNS.md
@/Users/fjacquet/Projects/camt-csv/internal/pdfparser/pdfparser.go
</context>

<tasks>

<task type="auto">
  <name>Remove debug file writing to working directory</name>
  <files>internal/pdfparser/pdfparser.go</files>
  <action>
Remove lines 95-103 that write debug_pdf_extract.txt to current working directory. This debug file accumulates in the CWD and can be committed to git or cause confusion.

If debug output is needed for troubleshooting, it should use the logger's debug level instead of a persistent file. The extracted text is already being processed and logged at appropriate levels.

Rationale: Debug files should never persist in the working directory. The logger already provides debug output capabilities without file pollution.
  </action>
  <verify>
Run: `grep -n "debug_pdf_extract" internal/pdfparser/pdfparser.go`
Expected: No matches (debug file code removed)

Run: `make test`
Expected: All tests pass, no debug files created in test directories
  </verify>
  <done>
- debug_pdf_extract.txt references removed from pdfparser.go
- No debug files created in working directory after PDF parsing
- Tests pass without creating debug artifacts
  </done>
</task>

<task type="auto">
  <name>Fix context propagation in ParseWithExtractor</name>
  <files>internal/pdfparser/pdfparser.go</files>
  <action>
Update ParseWithExtractor function (line 29-31) to:
1. Accept `ctx context.Context` as first parameter
2. Pass the context through to ParseWithExtractorAndCategorizer instead of creating context.Background()

Change signature from:
```go
func ParseWithExtractor(r io.Reader, extractor PDFExtractor, logger logging.Logger) ([]models.Transaction, error)
```

To:
```go
func ParseWithExtractor(ctx context.Context, r io.Reader, extractor PDFExtractor, logger logging.Logger) ([]models.Transaction, error)
```

Update line 30 from:
```go
return ParseWithExtractorAndCategorizer(context.Background(), r, extractor, logger, nil)
```

To:
```go
return ParseWithExtractorAndCategorizer(ctx, r, extractor, logger, nil)
```

Also update the Parse function (line 21-26) to accept and pass context:
```go
func Parse(ctx context.Context, r io.Reader, logger logging.Logger) ([]models.Transaction, error)
```

Pass context through:
```go
return ParseWithExtractor(ctx, r, NewRealPDFExtractor(), logger)
```

Rationale: Context propagation enables cancellation signals from callers to stop long-running PDF parsing operations. Currently the context is discarded, preventing proper cancellation support that was recently added to the application (see PROJECT.md decisions).
  </action>
  <verify>
Run: `grep -A 2 "func ParseWithExtractor" internal/pdfparser/pdfparser.go`
Expected: Function signature includes `ctx context.Context` parameter

Run: `grep "context.Background()" internal/pdfparser/pdfparser.go`
Expected: No matches in ParseWithExtractor (context.Background only used in test files is acceptable)

Run: `make test`
Expected: All tests pass with updated signatures
  </verify>
  <done>
- ParseWithExtractor accepts and uses context parameter
- Parse function accepts and passes context through
- No context.Background() calls in production code (tests excluded)
- Context cancellation properly propagates through PDF parsing
  </done>
</task>

<task type="auto">
  <name>Consolidate temporary file cleanup</name>
  <files>internal/pdfparser/pdfparser.go</files>
  <action>
Replace the two separate defer blocks (lines 44-55) with a single defer block that closes then removes the temporary file.

Current problematic code:
```go
defer func() {
    if err := os.Remove(tempFile.Name()); err != nil {
        logger.WithError(err).Warn("Failed to remove temporary file", ...)
    }
}()
defer func() {
    if err := tempFile.Close(); err != nil {
        logger.WithError(err).Warn("Failed to close temporary file", ...)
    }
}()
```

Replace with single defer block:
```go
defer func() {
    // Close file before removing
    if err := tempFile.Close(); err != nil {
        logger.WithError(err).Warn("Failed to close temporary file",
            logging.Field{Key: "file", Value: tempFile.Name()})
    }
    // Remove after closing
    if err := os.Remove(tempFile.Name()); err != nil {
        logger.WithError(err).Warn("Failed to remove temporary file",
            logging.Field{Key: "file", Value: tempFile.Name()})
    }
}()
```

Rationale: Two defer blocks create unclear resource ownership and can cause "close after delete" scenarios. Single defer with correct ordering (close then remove) ensures proper cleanup sequence.
  </action>
  <verify>
Run: `grep -A 10 "defer func" internal/pdfparser/pdfparser.go | grep -c "defer func"`
Expected: Only 1 defer block for temp file cleanup in ParseWithExtractorAndCategorizer

Run: `make test`
Expected: All tests pass, temp files properly cleaned up
  </verify>
  <done>
- Single defer block handles temp file cleanup
- Cleanup order is correct: close then remove
- Tests verify no temp file leakage
  </done>
</task>

</tasks>

<verification>
Run full test suite: `make test`
Parse a sample PDF and verify:
- No debug_pdf_extract.txt created in working directory
- Context cancellation stops parsing gracefully
- No temporary files left after parsing

Check updated function signatures:
```bash
grep "func Parse\|func ParseWithExtractor" internal/pdfparser/pdfparser.go
```
All should accept `ctx context.Context` as first parameter.
</verification>

<success_criteria>
1. No debug files appear in working directory after PDF parsing operations
2. All PDF parsing functions accept and propagate context for cancellation support
3. Temporary files are cleaned up in a single defer block with correct close-then-remove ordering
4. All existing tests pass with updated function signatures
5. No test creates debug_pdf_extract.txt artifacts
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bugs-and-security/01-01-SUMMARY.md`
</output>
