---
phase: 04-test-coverage-and-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/camt/camt_test.go
  - cmd/debit/debit_test.go
  - cmd/pdf/pdf_test.go
  - internal/logging/mock.go
autonomous: true

must_haves:
  truths:
    - "Command tests verify actual error messages when container is nil"
    - "Tests capture and inspect log output instead of just checking for panics"
    - "Fatal error log entries contain expected context and guidance"
  artifacts:
    - path: "cmd/camt/camt_test.go"
      provides: "Nil container test with log verification"
      contains: "VerifyFatalLog"
    - path: "cmd/debit/debit_test.go"
      provides: "Nil container test with log verification"
      contains: "VerifyFatalLog"
    - path: "cmd/pdf/pdf_test.go"
      provides: "Nil container test with log verification"
      contains: "VerifyFatalLog"
    - path: "internal/logging/mock.go"
      provides: "Helper method for fatal log verification"
      exports: ["VerifyFatalLog"]
  key_links:
    - from: "cmd/*/camt_test.go"
      to: "logging.MockLogger"
      via: "test helper injection"
      pattern: "mockLogger.*VerifyFatalLog"
---

<objective>
Enhance command tests to verify correct error behavior when container is nil, ensuring fatal errors are logged with clear messages and proper context instead of just checking for absence of panics.

Purpose: Close TEST-01 requirement by validating error output quality and user-facing error messages.
Output: Command tests that verify fatal error logging with actionable messages.
</objective>

<execution_context>
@/Users/fjacquet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fjacquet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-architecture-and-error-handling/03-01-SUMMARY.md

Current situation: Command tests have comments like "we're testing it doesn't panic" (cmd/camt/camt_test.go:66, cmd/debit/debit_test.go:78, cmd/pdf/pdf_test.go:78). Tests create nil containers but don't verify the fatal error logging behavior or message quality.

Error handling pattern from Phase 3: Fatal errors should log with Fatal level, include specific context, and provide actionable guidance to users.
</context>

<tasks>

<task type="auto">
  <name>Add log verification helper to MockLogger</name>
  <files>internal/logging/mock.go</files>
  <action>
Add a helper method `VerifyFatalLog(t *testing.T, expectedMessage string) bool` to MockLogger that:
- Searches the Entries slice for level "fatal" logs
- Verifies at least one fatal log contains the expectedMessage (substring match)
- Returns true if found, false otherwise
- Optionally prints all entries if verification fails for debugging

This helper enables tests to verify fatal error logging behavior instead of just checking for absence of panics.
  </action>
  <verify>Run `go test -v ./internal/logging -run TestMockLogger` to verify new helper compiles and basic usage works</verify>
  <done>MockLogger has VerifyFatalLog method that can check for fatal log entries with expected messages</done>
</task>

<task type="auto">
  <name>Update command tests to verify nil container error logging</name>
  <files>
cmd/camt/camt_test.go
cmd/debit/debit_test.go
cmd/pdf/pdf_test.go
  </files>
  <action>
For each command test file (camt, debit, pdf):

1. Replace "we're testing it doesn't panic" comments with "verify fatal error is logged with clear message"
2. Inject a MockLogger into the test setup (via root.AppContainer or direct logger override if available)
3. Update assertions to call `mockLogger.VerifyFatalLog(t, "Container not initialized")` or similar expected message
4. Verify the logged message contains actionable guidance for users

Use the error messages from CONVENTIONS.md as guidance for expected message content (specific context + actionable guidance).

Note: If direct logger injection is not possible due to command structure, document why verification is limited and ensure at minimum the test doesn't panic and the code path is exercised.
  </action>
  <verify>Run `go test -v ./cmd/camt ./cmd/debit ./cmd/pdf` to verify all tests pass with new verification logic</verify>
  <done>Command tests verify fatal error logging when container is nil, checking for clear messages with context and guidance</done>
</task>

</tasks>

<verification>
1. All command tests pass: `make test`
2. MockLogger has VerifyFatalLog helper method
3. Tests verify log output instead of just checking for panics
4. Fatal error messages include context (which command, what failed) and guidance (what user should do)
</verification>

<success_criteria>
- No command tests have comments saying "we're testing it doesn't panic"
- All nil container tests verify fatal error log entries
- Fatal error messages are clear, specific, and actionable
- Tests provide better diagnostics when failures occur (log output visible)
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage-and-safety/04-01-SUMMARY.md`
</output>
