# Milestone v1.1: Codebase Hardening

**Status:** SHIPPED 2026-02-01
**Phases:** 1-4
**Total Plans:** 11

## Overview

This milestone transforms camt-csv from a feature-complete but fragile tool into a hardened, maintainable foundation for future development. We address all identified concerns across four phases: first resolving critical bugs and security issues that directly impact users, then cleaning up deprecated configuration and global state, next standardizing error handling architecture, and finally closing test coverage gaps and adding safety features. Each phase delivers observable improvements in reliability and code quality.

## Phases

### Phase 1: Critical Bugs & Security

**Goal**: Users experience no data leaks, predictable behavior, and proper error handling in PDF parsing
**Depends on**: Nothing (first phase)
**Plans**: 3 plans in 1 wave

Plans:

- [x] 01-01-PLAN.md — PDF parser bug fixes (debug file, context propagation, temp cleanup)
- [x] 01-02-PLAN.md — MockLogger state isolation for test verification
- [x] 01-03-PLAN.md — Security hardening (credential logging, temp file naming, permissions)

**Success Criteria:**

1. No debug files accumulate in working directory after PDF parsing
2. All temporary files have unpredictable random names and are cleaned up properly
3. API credentials never appear in any log output at any level
4. File permissions are appropriate for content type (0644 for non-secrets, 0600 for credentials)
5. Context cancellation properly propagates through PDF parsing operations

### Phase 2: Configuration & State Cleanup

**Goal**: All configuration flows through DI container with no global state or deprecated functions
**Depends on**: Phase 1
**Plans**: 1 plan in 1 wave

Plans:

- [x] 02-01-PLAN.md — Remove deprecated config functions, global state, and fallback categorizer creation

**Success Criteria:**

1. No deprecated config functions exist in codebase (MustGetEnv, LoadEnv, GetEnv removed)
2. No global mutable state exists in config package (globalConfig, Logger removed)
3. Container initialization failures propagate as errors instead of silent fallback creation

### Phase 3: Architecture & Error Handling

**Goal**: Error handling is consistent, predictable, and never panics unexpectedly
**Depends on**: Phase 2
**Plans**: 3 plans in 2 waves

Plans:

- [x] 03-01-PLAN.md — Define error handling patterns and document in CONVENTIONS.md
- [x] 03-02-PLAN.md — Apply error patterns to commands and fix categorize init panic
- [x] 03-03-PLAN.md — Consolidate PDF parser to single temp directory

**Success Criteria:**

1. Error handling follows documented patterns across all commands (exit vs retry vs continue)
2. CLI initialization failures produce clear user-facing error messages instead of panics
3. PDF parser uses single temp file path instead of creating multiple temp files

### Phase 4: Test Coverage & Safety

**Goal**: Test suite thoroughly validates edge cases and safety features protect user data
**Depends on**: Phase 3
**Plans**: 4 plans in 1 wave

Plans:

- [x] 04-01-PLAN.md — Nil container error verification tests
- [x] 04-02-PLAN.md — Concurrent processing edge case tests
- [x] 04-03-PLAN.md — PDF format detection and error message tests
- [x] 04-04-PLAN.md — Category backup safety feature

**Success Criteria:**

1. Tests verify correct error behavior when container is nil (not just "doesn't panic")
2. Concurrent processing tests cover race conditions and context cancellation mid-processing
3. PDF format detection tests cover ambiguous cases (partial markers, markers in descriptions)
4. Error messages include file path and field context for all parsers
5. Category mapping YAML files are backed up with timestamps before auto-learning overwrites

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 1. Critical Bugs & Security | 3/3 | Complete | 2026-02-01 |
| 2. Configuration & State Cleanup | 1/1 | Complete | 2026-02-01 |
| 3. Architecture & Error Handling | 3/3 | Complete | 2026-02-01 |
| 4. Test Coverage & Safety | 4/4 | Complete | 2026-02-01 |

---

## Milestone Summary

**Key Decisions:**

- Minimal PDF parser fixes only (avoid full refactor)
- Bugs & security first priority
- Context propagation: all parser functions accept ctx parameter
- Debug logging via logger.Debug instead of file writing
- API credentials must never appear in logs at any level
- File permissions based on content: 0600 secrets, 0644 non-secrets, 0750 dirs
- Container nil case logs warning instead of creating unmanaged objects
- Remove deprecated functions only after all references migrated
- Three-tier error severity: fatal, retryable, recoverable
- init() should not panic — let Cobra handle MarkFlagRequired errors
- Backup enabled by default, failure prevents save (atomic behavior)
- TEST-01 accepted as adequate: os.Exit testing is known Go limitation

**Issues Resolved:**

- PDF debug file accumulation in working directory
- MockLogger state leaking between test assertions
- Context discarded in ParseWithExtractor
- Double temp file creation in PDF parser
- API credentials visible in debug logs
- Predictable temp file paths
- Deprecated config functions still in use
- Global mutable state in config package
- panic(err) in categorize command init
- Inconsistent error handling across commands

**Issues Deferred:**

- Full PDF strategy pattern refactor (REFAC-01)
- YAML store concurrent access protection (REFAC-02)
- Dry-run mode for categorization (SAFE-02)
- Batch error recovery (SAFE-03)
- Circuit breaker for Gemini API (RESIL-01)
- pdftotext installation detection (RESIL-02)
- Concurrent processing threshold tuning (PERF-01)
- Result channel streaming (PERF-02)

**Technical Debt Incurred:**

- GetLogrusAdapter() creates new logger when mock injected, preventing full Fatal log testing
- TEST-01 partially verified due to os.Exit architectural limitation

---

_For current project status, see .planning/ROADMAP.md_
_Archived: 2026-02-01_
